# 中文字体支持说明

## 概述

项目支持三种方式使用中文字体：

1. **SD 卡字体**（推荐）：将 `.bin` 字体文件放到 `/sdcard/字体/` 目录
2. **内置字体**：运行 `tools/gen_chinese_font.py` 生成并编译到固件中
3. **默认回退**：使用 LVGL 内置的 `montserrat` 字体（仅英文）

---

## 方法一：SD 卡字体（最简单）

### 1. 使用自动脚本生成字体

```bash
# 1. 安装依赖
npm install -g lv_font_conv

# 2. 运行脚本（会自动下载开源字体 Noto Sans SC）
cd tools
python3 gen_chinese_font.py

# 3. 将生成的 .bin 文件复制到 SD 卡
mkdir -p /sdcard/字体/
cp chinese_16.bin /sdcard/字体/
```

### 2. 手动生成字体

如果脚本自动下载失败，可以手动生成：

```bash
# 下载开源字体 Noto Sans SC
# https://github.com/notofonts/noto-cjk/releases

# 生成 16px 字体（约 700 个常用字符）
lv_font_conv \
  --font NotoSansSC-Regular.otf \
  --size 16 \
  --bpp 1 \
  --format bin \
  --no-compress \
  --symbols "的一是在不了有和人这中大为上个上我到要他说时来用们生到作地于出就分对成会可主发年动同工也能下过子说产种面而方后多定行学法所民得经十三之进着等部度家电力里如水化高自二理起小物现实量都两体制机当使点从业本去把性好应开它合还因由其些然前外天政四日那社义事平形相全表间样与关各重新线内数正心反你明看原又么利比或但质气第向道命此变条只没结解问意建月公无系军很情者最立代想已通并提直题党程展五果料象员革位入常文总次品式活设及管特件长求老头基资边流身认字导区强示律王集场卫计报身关击杀写候需况养疑难调预属支格更走足论布即德复病奇验激仅靠注虽依班完敌责杨排始练转约未读阿爸八百步北必采菜草层查厂产常车陈晨诚成吃出川传船春辞从担但谈打代带待袋淡弹当刀岛导道得灯等低地弟第电店调定冬东都度短段对多顿饿儿耳二发法反饭范方房防飞粉风否夫服福府父付副盖改感干刚高哥歌格个跟根工更公狗古骨故顾瓜刮官关光广归规果过海含汉好和号喝合河和黑很红后呼户花欢换回婚活火机鸡吉急级挤计记家加假价间件健将江讲交角脚叫教接节结姐界金今进近精九酒久旧救就居句决军开看烤课肯空孔苦快宽来蓝老乐冷离李理连亮凉林零流留六龙楼路绿伦乱罗马买卖满忙毛帽没门美米面眠名明母木拿哪内那南男尼年念鸟牛农弄怒女怕排牌盘跑配朋瓶皮平瓶七期其起汽汽器千钱前强桥且青清请庆秋缺然热人认日容肉如三色沙杀山扇伤商上绍少蛇舍设社申身神生胜师诗石时识史始世市事室视试收手首守书术树双谁水税睡说思四送诉算虽随孙所他她台太谈特提题体天条铁听停通同头土图团推外完玩晚王往忘望伟为位温文闻问我五无午物西息喜系夏鲜香乡项笑写谢心新信星行姓修秀雪寻牙烟颜言眼验羊阳洋养邀要爷也夜页一业阴音引友雨鱼语玉元院月晕云杂再在早造则怎增展站张章招找照者这正在整之知直值职指纸至制治中钟种终周洲猪主住助注抓转装准桌子字总走租嘴最罪作坐做" \
  --output chinese_16.bin
```

### 3. SD 卡目录结构

```
/sdcard/
├── 字体/              # 字体文件夹
│   ├── chinese_16.bin # 16px 中文字体
│   └── *.bin
├── 壁纸/              # 图片文件夹
│   └── *.jpg
└── *.txt              # 文本文件
```

---

## 方法二：内置字体（需要重新编译）

### 1. 生成字体源文件

```bash
cd tools
python3 gen_chinese_font.py
```

这会生成：
- `chinese_font.c` - 字体数据（C 数组）
- `chinese_font.h` - 头文件

### 2. 替换文件

将生成的文件复制到 `main/ui/` 目录，覆盖占位文件：

```bash
cp chinese_font.c ../main/ui/
cp chinese_font.h ../main/ui/
```

### 3. 重新编译

```bash
idf.py build
idf.py flash
```

---

## 字体参数说明

| 参数 | 说明 | 推荐值 |
|------|------|--------|
| `--size` | 字体大小 | 16 (适合电子墨水屏) |
| `--bpp` | 每像素位数 | 1 (黑白，最小) / 4 (灰度，更好) |
| `--format` | 输出格式 | bin |
| `--no-compress` | 不压缩 | 必须加，LVGL 才能直接使用 |

### 字体大小参考

| 字符数 | BPP=1 | BPP=4 |
|--------|-------|-------|
| 700 字 | ~50 KB | ~150 KB |
| 3000 字 | ~150 KB | ~500 KB |
| 7000 字 | ~300 KB | ~1 MB |

---

## 代码中使用中文字体

系统会自动扫描 SD 卡 `字体/` 目录下的 `.bin` 文件：

```c
#include "font_manager.h"

// 获取当前字体（会自动使用加载的中文字体）
lv_font_t *font = font_manager_get_font();

// 设置指定索引的字体
font_manager_set_font_by_index(0);  // 使用第一个扫描到的字体
```

---

## 故障排除

### 中文显示为方块（□）

1. 检查 SD 卡是否有 `/sdcard/字体/` 目录
2. 检查 `.bin` 文件是否存在
3. 查看日志中的字体扫描信息：
   ```
   I (1234) FONT_LOADER: Found 0 fonts  ← 没有找到字体
   I (1234) FONT_LOADER: Found 1 fonts   ← 成功
   ```

### 内存不足

如果字体加载失败，尝试：
- 减少字符数量（只用最常用的字符）
- 降低 BPP（4 → 1）
- 使用流式加载（`font_stream.c`）

### gen_chinese_font.py 下载失败

1. 手动下载 Noto Sans SC 字体：
   - https://github.com/notofonts/noto-cjk/releases
   - 解压后找到 `.otf` 或 `.ttf` 文件
2. 将字体文件放到 `tools/` 目录
3. 修改脚本，直接使用本地字体

---

## 当前状态

- **文件系统路径**: 已修复，`S:/壁纸/xxx.jpg` 正确映射到 `/sdcard/壁纸/xxx.jpg`
- **内置字体**: 占位实现，需要运行 `gen_chinese_font.py` 生成实际字体数据
- **SD 卡字体**: 完全支持，将 `.bin` 文件放入 `/sdcard/字体/` 目录即可
