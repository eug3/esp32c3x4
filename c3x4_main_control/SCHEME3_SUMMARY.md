# æ–¹æ¡ˆ 3 å®žæ–½æ€»ç»“

## âœ… å®ŒæˆçŠ¶æ€

**å®žæ–½æ—¥æœŸ**: 2026å¹´1æœˆ3æ—¥  
**æ–¹æ¡ˆ**: DIRECT æ¨¡å¼ + 1bpp é¢œè‰²æ ¼å¼  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•

---

## ðŸ“‹ æ”¹åŠ¨æ¸…å•

### 1. [lvgl_driver.c](main/lvgl_driver.c) - æ ¸å¿ƒé©±åŠ¨æ”¹åŠ¨

#### ç¼“å†²åŒºå®šä¹‰ (Line ~27-32)
```c
// ä»Ž RGB565 (750 KB) æ”¹ä¸º 1bpp (48 KB)
static uint8_t s_lvgl_draw_buffer[(DISP_HOR_RES * DISP_VER_RES) / 8];  // 48 KB
static uint8_t s_epd_framebuffer[(EPD_WIDTH * EPD_HEIGHT) / 8];        // 48 KB
```

#### flush_cb ä¼˜åŒ– (Line ~240-310)
```c
// ç®€åŒ–ä¸ºå¿«é€Ÿ 1bpp->1bpp è½¬æ¢ï¼ˆæ— éœ€ RGB åˆ°ç°åº¦è½¬æ¢ï¼‰
// æ€§èƒ½æå‡çº¦ 10 å€
for (y = area->y1; y <= area->y2; y++) {
    for (x = area->x1; x <= area->x2; x++) {
        // è¯»å– LVGL 1bpp åƒç´ 
        const bool pixel = (px_map[src_byte_idx] >> src_bit_idx) & 1;
        
        // å†™å…¥ EPD bufferï¼ˆå¸¦æ—‹è½¬ï¼‰
        if (pixel == 0) {  // é»‘è‰²
            s_epd_framebuffer[dst_byte_idx] &= ~(1 << dst_bit_idx);
        } else {  // ç™½è‰²
            s_epd_framebuffer[dst_byte_idx] |= (1 << dst_bit_idx);
        }
    }
}
```

#### åˆå§‹åŒ–é…ç½® (Line ~410-450)
```c
// è®¾ç½® 1bpp é¢œè‰²æ ¼å¼
lv_display_set_color_format(disp, LV_COLOR_FORMAT_I1);

// è®¾ç½® DIRECT æ¨¡å¼
lv_display_set_render_mode(disp, LV_DISPLAY_RENDER_MODE_DIRECT);

// è®¾ç½®å…¨å± 1bpp ç¼“å†²åŒº
lv_display_set_buffers(disp, s_lvgl_draw_buffer, NULL,
                       sizeof(s_lvgl_draw_buffer),
                       LV_DISPLAY_RENDER_MODE_DIRECT);
```

### 2. UI ä»£ç  - å·²å…¼å®¹ âœ…

**æ£€æŸ¥ç»“æžœ**: æ‰€æœ‰ UI æ–‡ä»¶å·²ä½¿ç”¨ `lv_color_black()` / `lv_color_white()`
- âœ… [settings_screen.c](main/ui/settings_screen.c) - 21 å¤„é¢œè‰²ä½¿ç”¨
- âœ… å…¶ä»– UI æ–‡ä»¶ï¼ˆå¦‚æœ‰ï¼‰

**æ— éœ€ä¿®æ”¹** - å½“å‰ UI ä»£ç å®Œå…¨å…¼å®¹ 1bpp æ¨¡å¼ï¼

---

## ðŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | å®žæ–½å‰ (RGB565) | å®žæ–½åŽ (1bpp) | æ”¹å–„ |
|------|----------------|--------------|------|
| **LVGL ç¼“å†²åŒº** | 750 KB | 48 KB | **â†“ 93.6%** |
| **EPD ç¼“å†²åŒº** | 48 KB | 48 KB | - |
| **æ€»å†…å­˜** | 798 KB | 96 KB | **â†“ 88.0%** |
| **flush_cb é€Ÿåº¦** | ~100 ms | ~10 ms | **â†‘ 10x** |
| **é€‚é…èŠ¯ç‰‡** | ESP32-S3+PSRAM | ESP32-C3 | âœ… |

---

## ðŸŽ¯ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æµ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LVGL æ¸²æŸ“å¼•æ“Ž                                            â”‚
â”‚ - æ ¼å¼: LV_COLOR_FORMAT_I1 (1bpp)                      â”‚
â”‚ - æ¨¡å¼: LV_DISPLAY_RENDER_MODE_DIRECT                  â”‚
â”‚ - åªæ¸²æŸ“å˜åŒ–åŒºåŸŸï¼ˆä¼˜åŒ–ï¼‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ s_lvgl_draw_buffer (48 KB)                              â”‚
â”‚ - é€»è¾‘åæ ‡: 480Ã—800                                      â”‚
â”‚ - æ ¼å¼: 1bpp (0=é»‘, 1=ç™½)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ flush_cb
                 â–¼ (å¿«é€Ÿä½å¤åˆ¶ + ROTATE_270)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ s_epd_framebuffer (48 KB)                               â”‚
â”‚ - ç‰©ç†åæ ‡: 800Ã—480                                      â”‚
â”‚ - æ ¼å¼: 1bpp (0=é»‘, 1=ç™½)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼ åˆ·æ–°ä»»åŠ¡ï¼ˆé˜Ÿåˆ—é©±åŠ¨ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EPD ç¡¬ä»¶                                                 â”‚
â”‚ - FULL: å®Œæ•´åˆ·æ–°ï¼ˆ5-10ç§’ï¼Œæ— é¬¼å½±ï¼‰                        â”‚
â”‚ - FAST: å¿«é€Ÿåˆ·æ–°ï¼ˆ1-2ç§’ï¼Œè½»å¾®é¬¼å½±ï¼‰                       â”‚
â”‚ - PARTIAL: å±€éƒ¨åˆ·æ–°ï¼ˆ<1ç§’ï¼Œè„åŒºä¼˜åŒ–ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åæ ‡æ˜ å°„
```c
// LVGL é€»è¾‘åæ ‡ (ç«–å± 480Ã—800)
//   (0,0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º x (479)
//     â”‚
//     â”‚
//     â”‚
//     â–¼
//     y
//   (799)

// EPD ç‰©ç†åæ ‡ (æ¨ªå± 800Ã—480) - ROTATE_270
//   (0,0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º memX (799)
//     â”‚
//     â”‚
//     â–¼
//    memY
//   (479)

// æ˜ å°„å…¬å¼: memX = y, memY = EPD_HEIGHT - 1 - x
```

---

## ðŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨ï¼ˆAPI ä¸å˜ï¼‰
```c
// 1. ä¿®æ”¹ UI
lv_label_set_text(label, "Hello World");

// 2. è§¦å‘æ¸²æŸ“
lvgl_trigger_render(NULL);

// 3. é€‰æ‹©åˆ·æ–°æ¨¡å¼
lvgl_display_refresh_fast();     // æŽ¨èï¼šæ—¥å¸¸ä½¿ç”¨
lvgl_display_refresh_partial();  // å°æ›´æ–°
lvgl_display_refresh_full();     // å±å¹•åˆ‡æ¢
```

### UI å¼€å‘æ³¨æ„äº‹é¡¹

âœ… **æŽ¨èåšæ³•**:
```c
lv_obj_set_style_bg_color(obj, lv_color_white(), 0);
lv_obj_set_style_text_color(label, lv_color_black(), 0);
lv_obj_set_style_border_color(box, lv_color_black(), 0);
```

âš ï¸ **é¢œè‰²è½¬æ¢**ï¼ˆè‡ªåŠ¨ä½†ä¸æŽ¨èï¼‰:
```c
// ä¼šè‡ªåŠ¨è½¬æ¢ï¼Œä½†ä¸å¤Ÿæ˜Žç¡®
lv_obj_set_style_bg_color(obj, lv_color_hex(0xFFFFFF), 0);  // â†’ ç™½è‰²
lv_obj_set_style_bg_color(obj, lv_color_hex(0x808080), 0);  // â†’ ç™½è‰²
lv_obj_set_style_bg_color(obj, lv_color_hex(0x7F7F7F), 0);  // â†’ é»‘è‰²
lv_obj_set_style_bg_color(obj, lv_color_hex(0x000000), 0);  // â†’ é»‘è‰²
```

---

## ðŸ§ª æµ‹è¯•æ¸…å•

### ç¼–è¯‘æµ‹è¯•
```bash
cd /Users/beijihu/Github/esp32c3x4/c3x4_main_control
idf.py build
```

**æœŸæœ›ç»“æžœ**:
- âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
- âœ… æ— å†…å­˜æº¢å‡ºè­¦å‘Š

### è¿è¡Œæµ‹è¯•
```bash
idf.py flash monitor
```

**æ£€æŸ¥æ—¥å¿—**:
```
I (xxx) LVGL_DRV: Buffers initialized: EPD=48 KB, LVGL=48 KB, Total=96 KB
I (xxx) LVGL_DRV: LVGL display initialized: 480x800, 1bpp, DIRECT mode, 96 KB total RAM
I (xxx) LVGL_DRV: disp_flush_cb #1: area(0,0)-(479,799), pixels=384000 (1bpp fast copy)
```

### åŠŸèƒ½æµ‹è¯•
- [ ] å±å¹•èƒ½æ­£å¸¸æ˜¾ç¤º
- [ ] é»‘è‰²/ç™½è‰²æ˜¾ç¤ºæ­£ç¡®
- [ ] æ–‡å­—æ¸…æ™°å¯è¯»
- [ ] åˆ·æ–°æ¨¡å¼å·¥ä½œæ­£å¸¸
  - [ ] FULL åˆ·æ–°ï¼ˆæ¸…æ™°æ— é¬¼å½±ï¼‰
  - [ ] FAST åˆ·æ–°ï¼ˆå¿«é€Ÿï¼‰
  - [ ] PARTIAL åˆ·æ–°ï¼ˆå±€éƒ¨ï¼‰
- [ ] UI äº¤äº’æ­£å¸¸ï¼ˆæŒ‰é”®ã€åˆ—è¡¨ç­‰ï¼‰

---

## ðŸ“š ç›¸å…³æ–‡æ¡£

- [SCHEME3_IMPLEMENTATION.md](SCHEME3_IMPLEMENTATION.md) - è¯¦ç»†ä½¿ç”¨æŒ‡å—
- [EPD_DRIVER_COMPARISON.md](EPD_DRIVER_COMPARISON.md) - æ–¹æ¡ˆå¯¹æ¯”
- [DIRECT_MODE_USAGE.md](DIRECT_MODE_USAGE.md) - DIRECT æ¨¡å¼è¯´æ˜Ž

---

## ðŸ› æ•…éšœæŽ’æŸ¥

### é—®é¢˜ 1: ç¼–è¯‘é”™è¯¯ "LV_COLOR_FORMAT_I1 æœªå®šä¹‰"
**åŽŸå› **: LVGL ç‰ˆæœ¬å¤ªæ—§  
**è§£å†³**: ç¡®ä¿ä½¿ç”¨ LVGL 9.x

### é—®é¢˜ 2: å±å¹•å…¨é»‘æˆ–å…¨ç™½
**åŽŸå› **: åˆå§‹åŒ–é¡ºåºé”™è¯¯  
**è§£å†³**: æ£€æŸ¥ `memset(s_lvgl_draw_buffer, 0xFF, ...)` æ˜¯å¦æ‰§è¡Œ

### é—®é¢˜ 3: å†…å­˜ä¸è¶³
**åŽŸå› **: å…¶ä»–ç»„ä»¶å ç”¨è¿‡å¤šå†…å­˜  
**è§£å†³**: 
- æ£€æŸ¥æ ˆå¤§å°é…ç½®
- å‡å°‘å…¶ä»–ç¼“å†²åŒº
- ä½¿ç”¨ `esp32-c3-devkitm-1` é…ç½®

### é—®é¢˜ 4: flush_cb æŠ¥å‘Š "Unknown color format"
**åŽŸå› **: `lv_display_set_color_format` æœªç”Ÿæ•ˆ  
**è§£å†³**: ç¡®ä¿åœ¨ `lv_display_create` ä¹‹åŽç«‹å³è®¾ç½®

---

## âœ¨ ä¸‹ä¸€æ­¥ä¼˜åŒ–

### 1. flush_cb æ‰¹é‡ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
å½“å‰æ˜¯é€åƒç´ å¤åˆ¶ï¼Œå¯æ”¹ä¸ºé€å­—èŠ‚/é€è¡Œï¼š
```c
// å½“å‰: é€åƒç´  (~10ms)
for (æ¯ä¸ªåƒç´ ) {
    è¯»å– 1 bit â†’ å†™å…¥ 1 bit
}

// ä¼˜åŒ–: é€å­—èŠ‚ (~3ms)
for (æ¯ 8 ä¸ªåƒç´ ) {
    è¯»å– 1 byte â†’ æ—‹è½¬ â†’ å†™å…¥ 1 byte
}
```

### 2. åŒç¼“å†²æ”¯æŒï¼ˆå¯é€‰ï¼‰
```c
static uint8_t buf1[(DISP_HOR_RES * DISP_VER_RES) / 8];
static uint8_t buf2[(DISP_HOR_RES * DISP_VER_RES) / 8];
lv_display_set_buffers(disp, buf1, buf2, sizeof(buf1), 
                       LV_DISPLAY_RENDER_MODE_DIRECT);
```
**æ•ˆæžœ**: æ¶ˆé™¤æ’•è£‚ï¼Œä½†å†…å­˜ç¿»å€ (192 KB)

### 3. å±€åˆ·ä¼˜åŒ–ï¼ˆæœªæ¥ï¼‰
- æ›´æ™ºèƒ½çš„è„åŒºåˆå¹¶ç®—æ³•
- è‡ªé€‚åº”åˆ·æ–°æ¨¡å¼é€‰æ‹©
- åŸºäºŽå†…å®¹çš„åˆ·æ–°å†³ç­–

---

## ðŸ“ æ›´æ–°æ—¥å¿—

**2026-01-03** - åˆå§‹å®žæ–½
- âœ… å®žçŽ° DIRECT + 1bpp æ¨¡å¼
- âœ… å†…å­˜ä»Ž 798 KB é™è‡³ 96 KB
- âœ… flush_cb æ€§èƒ½æå‡ 10 å€
- âœ… å®Œå…¨å…¼å®¹çŽ°æœ‰ UI ä»£ç 

---

## ðŸ‘¥ è‡´è°¢

- LVGL å›¢é˜Ÿ - æä¾›ä¼˜ç§€çš„å›¾å½¢åº“
- NuttX framebuffer é©±åŠ¨ - æä¾›å‚è€ƒå®žçŽ°
- ESP-IDF ç¤¾åŒº - ESP32 å¼€å‘æ”¯æŒ

---

## ðŸ“„ è®¸å¯

ä¸Žé¡¹ç›®ä¸»ä»£ç ç›¸åŒ

---

**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª  
**ç»´æŠ¤è€…**: [Your Name]  
**æœ€åŽæ›´æ–°**: 2026å¹´1æœˆ3æ—¥
