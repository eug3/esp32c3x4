/**
 * @file home_screen.c
 * @brief 首页屏幕实现 - 手绘 UI 版本
 */

#include "home_screen.h"
#include "display_engine.h"
#include "ui_region_manager.h"
#include "font_renderer.h"
#include "esp_log.h"
#include <string.h>

static const char *TAG = "HOME_SCREEN";

// 首页屏幕实例
static screen_t g_home_screen = {0};

// 菜单状态
static struct {
    menu_item_t selected_item;     // 当前选中的菜单项
    menu_item_t prev_selected_item; // 上一个选中项（用于局部刷新）
    int display_offset;            // 显示偏移（用于滚动）
} s_menu_state = {
    .selected_item = MENU_ITEM_FILE_BROWSER,
    .prev_selected_item = MENU_ITEM_FILE_BROWSER,
    .display_offset = 0,
};

// 屏幕上下文
static screen_context_t *s_context = NULL;

// 菜单项信息
typedef struct {
    const char *label;             // 菜单标签
    const char *icon;              // 图标（可选）
} menu_info_t;

static const menu_info_t s_menu_items[MENU_ITEM_COUNT] = {
    [MENU_ITEM_FILE_BROWSER] = { .label = "Files", .icon = NULL },
    [MENU_ITEM_SETTINGS]       = { .label = "Settings", .icon = NULL },
};

/**********************
 *  STATIC PROTOTYPES
 **********************/

static void on_show(screen_t *screen);
static void draw_menu_item(int index, bool is_selected);
static void get_menu_item_region(int index, ui_region_t *region);
static void redraw_menu_item_callback(const ui_region_t *region, void *user_data);
static void on_hide(screen_t *screen);
static void on_draw(screen_t *screen);
static void on_event(screen_t *screen, button_t btn, button_event_t event);

/**********************
 *  STATIC FUNCTIONS
 **********************/

static void on_show(screen_t *screen)
{
    ESP_LOGI(TAG, "Home screen shown");
    s_context = screen_manager_get_context();
    screen->needs_redraw = true;
}

static void on_hide(screen_t *screen)
{
    ESP_LOGI(TAG, "Home screen hidden");
    s_context = NULL;
}

static void on_draw(screen_t *screen)
{
    ESP_LOGI(TAG, "on_draw START");
    
    if (s_context == NULL) {
        ESP_LOGW(TAG, "s_context is NULL!");
        return;
    }

    // 清屏
    ESP_LOGI(TAG, "Clearing screen...");
    display_clear(COLOR_WHITE);
    ESP_LOGI(TAG, "Screen cleared");

    // 绘制标题栏
    int title_y = 20;
    ESP_LOGI(TAG, "Drawing title...");
    display_draw_text(20, title_y, "Xteink X4 eReader", COLOR_BLACK, COLOR_WHITE);

    // 绘制电池信息
    char bat_str[32];
    snprintf(bat_str, sizeof(bat_str), "BAT: %u%%", s_context->battery_pct);
    int bat_width = display_get_text_width(bat_str, 12);
    display_draw_text(SCREEN_WIDTH - bat_width - 20, title_y, bat_str, COLOR_BLACK, COLOR_WHITE);

    // 绘制版本信息
    if (s_context->version_str != NULL) {
        display_draw_text(20, SCREEN_HEIGHT - 30, s_context->version_str, COLOR_BLACK, COLOR_WHITE);
    }

    // 绘制菜单
    int menu_start_y = 100;
    int menu_item_height = 60;
    int menu_width = 400;
    int menu_x = (SCREEN_WIDTH - menu_width) / 2;

    for (int i = 0; i < MENU_ITEM_COUNT; i++) {
        int item_y = menu_start_y + i * menu_item_height;
        bool is_selected = (i == s_menu_state.selected_item);

        // 绘制菜单项背景
        if (is_selected) {
            display_draw_rect(menu_x - 10, item_y - 5, menu_width + 20, menu_item_height - 10,
                             COLOR_BLACK, true);
            display_draw_text(menu_x, item_y, s_menu_items[i].label, COLOR_WHITE, COLOR_BLACK);
        } else {
            display_draw_rect(menu_x - 10, item_y - 5, menu_width + 20, menu_item_height - 10,
                             COLOR_BLACK, false);
            display_draw_text(menu_x, item_y, s_menu_items[i].label, COLOR_BLACK, COLOR_WHITE);
        }
    }

    // 绘制底部提示
    display_draw_text(20, SCREEN_HEIGHT - 60, "UP/DOWN: Navigate  CONFIRM: Select",
                     COLOR_BLACK, COLOR_WHITE);
    
/**
 * @brief 绘制单个菜单项
 */
static void draw_menu_item(int index, bool is_selected)
{
    int menu_start_y = 100;
    int menu_item_height = 60;
    int menu_width = 400;
    int menu_x = (SCREEN_WIDTH - menu_width) / 2;
menu_item_t old_selection = s_menu_state.selected_item;
    menu_item_t new_selection = old_selection;

    switch (btn) {
        case BTN_LEFT:
        case BTN_VOLUME_UP:
            // 向上导航
            if (s_menu_state.selected_item > 0) {
                new_selection = s_menu_state.selected_item - 1;
            }
            break;

        case BTN_RIGHT:
        case BTN_VOLUME_DOWN:
            // 向下导航
            if (s_menu_state.selected_item < MENU_ITEM_COUNT - 1) {
                new_selection = s_menu_state.selected_item + 1;
            }
            break;

        case BTN_CONFIRM:
            // 确认选择
            switch (s_menu_state.selected_item) {
                case MENU_ITEM_FILE_BROWSER:
                    screen_manager_show_file_browser();
                    break;
                case MENU_ITEM_SETTINGS:
                    screen_manager_show_settings();
                    break;
                default:
                    break;
            }
            return;

        case BTN_BACK:
            // 返回键（在首页无效果）
            ESP_LOGI(TAG, "Already at home screen");
            return;

        default:
            return;
    }

    // 如果焦点改变，使用区域管理器进行局部刷新
    if (new_selection != old_selection) {
        ESP_LOGI(TAG, "Focus changed: %d -> %d", old_selection, new_selection);
        
        s_menu_state.selected_item = new_selection;

        // 创建区域管理器（按顺序局刷）
        ui_region_manager_t region_mgr;
        ui_region_manager_init(&region_mgr, true);  // auto_refresh = true，每个区域刷新后立即局刷

        // 获取旧焦点和新焦点的区域
        ui_region_t old_region, new_region;
        get_menu_item_region(old_selection, &old_region);
        get_menu_item_region(new_selection, &new_region);

        // 添加两个需要更新的区域
        ui_region_manager_add_region(&region_mgr, 
                                      old_region.x, old_region.y, 
                                      old_region.width, old_region.height);
        ui_region_manager_add_region(&region_mgr, 
                                      new_region.x, new_region.y, 
                                      new_region.width, new_region.height);

        // 方法1：使用回调函数逐个重绘（更灵活，但需要传递索引）
        // 这里我们采用prev_selected_item = MENU_ITEM_FILE_BROWSER;
    s_menu_state.更简单的方法2：直接绘制两个菜单项
        
        ESP_LOGI(TAG, "Redrawing old focus item %d (deselected)", old_selection);
        draw_menu_item(old_selection, false);
        display_refresh_region(old_region.x, old_region.y, 
                              old_region.width, old_region.height, 
                              REFRESH_MODE_PARTIAL);

        ESP_LOGI(TAG, "Redrawing new focus item %d (selected)", new_selection);
        draw_menu_item(new_selection, true);
        display_refresh_region(new_region.x, new_region.y, 
                              new_region.width, new_region.height, 
                              REFRESH_MODE_PARTIAL);

        ESP_LOGI(TAG, "Focus update complete")
    if (item_index == NULL) {
        ESP_LOGW(TAG, "Invalid user_data in callback");
        return;
    }

    int index = *item_index;
    if (index < 0 || index >= MENU_ITEM_COUNT) {
        ESP_LOGW(TAG, "Invalid item index: %d", index);
        return;
    }

    bool is_selected = (index == s_menu_state.selected_item);
    ESP_LOGI(TAG, "Redrawing menu item %d (selected=%d)", index, is_selected);
    draw_menu_item(index, is_selected);
}

    ESP_LOGI(TAG, "on_draw END");
}

static void on_event(screen_t *screen, button_t btn, button_event_t event)
{
    if (event != BTN_EVENT_PRESSED) {
        return;
    }

    switch (btn) {
        case BTN_LEFT:
        case BTN_VOLUME_UP:
            // 向上导航
            if (s_menu_state.selected_item > 0) {
                s_menu_state.selected_item--;
                screen->needs_redraw = true;
                screen_manager_draw();
                display_refresh(REFRESH_MODE_PARTIAL);
            }
            break;

        case BTN_RIGHT:
        case BTN_VOLUME_DOWN:
            // 向下导航
            if (s_menu_state.selected_item < MENU_ITEM_COUNT - 1) {
                s_menu_state.selected_item++;
                screen->needs_redraw = true;
                screen_manager_draw();
                display_refresh(REFRESH_MODE_PARTIAL);
            }
            break;

        case BTN_CONFIRM:
            // 确认选择
            switch (s_menu_state.selected_item) {
                case MENU_ITEM_FILE_BROWSER:
                    screen_manager_show_file_browser();
                    break;
                case MENU_ITEM_SETTINGS:
                    screen_manager_show_settings();
                    break;
                default:
                    break;
            }
            break;

        case BTN_BACK:
            // 返回键（在首页无效果）
            ESP_LOGI(TAG, "Already at home screen");
            break;

        default:
            break;
    }
}

/**********************
 * GLOBAL FUNCTIONS
 **********************/

void home_screen_init(void)
{
    ESP_LOGI(TAG, "Initializing home screen");

    // 初始化屏幕结构
    g_home_screen.name = "home";
    g_home_screen.user_data = NULL;
    g_home_screen.on_show = on_show;
    g_home_screen.on_hide = on_hide;
    g_home_screen.on_draw = on_draw;
    g_home_screen.on_event = on_event;
    g_home_screen.is_visible = false;
    g_home_screen.needs_redraw = false;

    // 重置菜单状态
    s_menu_state.selected_item = MENU_ITEM_FILE_BROWSER;
    s_menu_state.display_offset = 0;
}

screen_t* home_screen_get_instance(void)
{
    if (g_home_screen.name == NULL) {
        home_screen_init();
    }
    return &g_home_screen;
}
