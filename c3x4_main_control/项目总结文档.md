# ESP32-C3 电子纸显示控制项目总结文档

## 项目概述

这是一个基于ESP-IDF的ESP32-C3电子纸（E-Paper）显示控制项目，主要用于控制4.26英寸电子墨水屏显示。项目结合了硬件逆向分析、低功耗设计和无线通信功能，是一个功能完整的电子墨水屏显示解决方案。

## 项目结构

### 目录结构
```
d:\esp32c3x4\c3x4_main_control\
├── main/                    # 主源代码目录
│   ├── main.c              # 主程序文件（56KB）
│   ├── DEV_Config.h        # 设备配置头文件
│   ├── DEV_Config.c        # 设备配置实现
│   ├── EPD_4in26.c/h       # 4.26英寸电子纸驱动
│   ├── GUI_Paint.c/h       # 图形界面绘制库
│   ├── ImageData.h         # 图像数据
│   ├── Fonts/              # 字体文件目录
│   ├── CMakeLists.txt      # main组件CMake配置
│   └── idf_component.yml   # IDF组件配置
├── docs/                   # 文档目录
│   └── EPD_pin_investigation.md  # EPD引脚逆向分析报告
├── GDEQ0426T82_Arduino/    # Arduino兼容代码
│   ├── GDEQ0426T82_Arduino.ino
│   └── Display_EPD_W21.cpp/.h
├── examples/               # 示例代码目录
├── tools/                  # 工具脚本目录
│   └── epd_pin_test.py     # EPD引脚测试工具
├── .vscode/               # VSCode配置
│   └── settings.json
├── .devcontainer/         # 开发容器配置
├── CMakeLists.txt         # 主CMake配置文件
├── README.md              # 项目说明文档
├── partitions.csv         # ESP32分区表配置
├── dependencies.lock      # 依赖锁定文件
├── sdkconfig.ci          # CI配置文件
└── pytest_hello_world.py  # Python测试脚本
```

## 硬件配置

### 主控芯片
- **型号**: ESP32-C3
- **架构**: RISC-V 32位单核处理器
- **频率**: 160MHz
- **内存**: 400KB SRAM
- **存储**: 4MB Flash

### 显示屏
- **类型**: 4.26英寸电子纸（E-Paper/电子墨水屏）
- **控制器**: SSD1677/GDEQ0426T82兼容
- **分辨率**: 800×480像素
- **接口**: SPI

### 引脚映射（已通过逆向工程确认）
通过IDA逆向分析固件，确认的EPD引脚映射：

| 信号 | GPIO引脚 | 功能说明 |
|------|----------|----------|
| CS   | GPIO 4   | 片选信号 |
| DC   | GPIO 5   | 数据/命令选择 |
| RST  | GPIO 6   | 复位信号 |
| BUSY | GPIO 7   | 忙状态检测 |
| MOSI | GPIO 8   | SPI数据输出 |
| SCLK | GPIO 10  | SPI时钟 |

### 其他硬件接口
- **睡眠按钮**: GPIO 9（单击进入深度睡眠，双击重新测试EPD）
- **SD卡接口**:
  - MISO: GPIO 6
  - MOSI: GPIO 7
  - CLK: GPIO 8
  - CS: GPIO 9

## 软件架构

### 核心功能模块

#### 1. 电子纸显示控制
- **驱动层**: EPD_4in26.c/h - 底层SPI通信和控制器命令
- **图形层**: GUI_Paint.c/h - 图形绘制、字体显示功能
- **配置层**: DEV_Config.c/h - 硬件抽象和引脚配置

#### 2. 无线通信
- **BLE蓝牙**:
  - 服务UUID: 0x1234
  - 图像数据特征: 0x5678（接收手机图像数据）
  - 控制命令特征: 0x5679（发送控制命令到手机）
- **WiFi网络**:
  - HTTP服务器功能
  - 网络配置和管理

#### 3. 电源管理
- **深度睡眠模式**: 通过GPIO9按键触发
- **功耗优化**: 深度睡眠时功耗10-20μA
- **唤醒机制**: 外部中断唤醒

#### 4. 存储系统
- **LittleFS文件系统**: 挂载点`/littlefs`
- **SD卡支持**: 通过SPI接口读写
- **图像存储**: 支持将接收的图像保存到SD卡

### 数据协议

#### BLE图像传输协议
```
帧头格式（12字节）:
0..3  : ASCII 'X4IM'
4     : 版本号 = 1
5     : 格式 = 1 (RGB565 little-endian)
6..7  : 保留
8..11 : 有效载荷长度 (uint32 LE)
```

#### JSON布局协议
```
帧头格式（12字节）:
0..3  : ASCII 'X4JS'
4     : 版本号 = 1
5..7  : 保留
8..11 : 有效载荷长度 (uint32 LE)
```

## 逆向工程分析

### 分析过程
项目通过IDA Pro对原始固件进行逆向分析，确定了正确的EPD引脚映射：

1. **字符串分析**: 发现"XT-EPD"、"E-Paper1"、"Busy Timeout!"等关键字符串
2. **函数追踪**: 定位到`gpio_matrix_out`/`gpio_matrix_in`等GPIO相关函数
3. **常量提取**: 从数据段提取引脚常量值
4. **交叉验证**: 与硬件测量结果对比验证

### 关键发现
- 原始固件中EPD结构体位于`0x3FC96310`
- 确认了SSD系列控制器命令集（SSD1677兼容）
- 发现固件中没有独立的电源控制引脚（EPD_PWR_PIN = -1）

详细分析见：[docs/EPD_pin_investigation.md](docs/EPD_pin_investigation.md)

## 开发环境

### 构建系统
- **框架**: ESP-IDF v6.1
- **构建工具**: CMake 3.22+
- **编程语言**: C语言
- **Python环境**: Python 3.14

### 开发工具
- **IDE**: VSCode + ESP-IDF插件
- **调试工具**: OpenOCD + ESP32-C3配置
- **代码分析**: clangd

### 环境配置（原macOS环境）
```json
{
  "idf.espIdfPath": "/Users/beijihu/esp/esp-idf",
  "idf.pythonInstallPath": "/opt/homebrew/bin/python3",
  "idf.port": "/dev/tty.usbmodem2101",
  "idf.toolsPath": "/Users/beijihu/.espressif",
  "IDF_TARGET": "esp32c3"
}
```

## 构建和部署

### 构建命令
```bash
# 构建项目
idf.py build

# 刷写固件
idf.py -p PORT flash

# 串口监视
idf.py -p PORT monitor

# 清理构建
idf.py fullclean
```

### 配置选项
项目支持多种驱动测试：
```c
#define TEST_DRIVER_SSD1677 1
#define TEST_DRIVER_GDEQ0426T82 2
#define TEST_DRIVER_SSD1681 3

#define CURRENT_DRIVER TEST_DRIVER_SSD1681  // 可切换不同驱动
```

## 功能特性

### 核心功能
1. **电子纸显示**: 支持4.26英寸电子墨水屏全功能控制
2. **图形绘制**: 提供基本的图形绘制和字体显示功能
3. **图像传输**: 通过BLE从手机接收并显示图像
4. **文件存储**: 支持LittleFS和SD卡存储
5. **网络服务**: HTTP服务器提供Web界面

### 电源管理
1. **深度睡眠**: 超低功耗模式（10-20μA）
2. **按键控制**: GPIO9按键控制睡眠和唤醒
3. **双击功能**: 双击按钮重新测试EPD显示

### 通信协议
1. **BLE GATT服务**: 完整的图像数据传输协议
2. **HTTP REST API**: 简单的Web控制接口
3. **串口调试**: 丰富的调试信息输出

## 项目状态

### 已完成功能
- [x] EPD引脚逆向分析和确认
- [x] 基本电子纸显示功能
- [x] BLE图像传输协议
- [x] 深度睡眠电源管理
- [x] 按键控制功能
- [x] SD卡文件系统
- [x] LittleFS支持
- [x] HTTP服务器

### 待完善功能
- [ ] Web界面优化
- [ ] 图像压缩传输
- [ ] OTA固件升级
- [ ] 多语言支持
- [ ] 高级电源管理

## 使用场景

### 适用领域
1. **电子标签**: 零售价签、库存管理
2. **信息显示**: 公交站牌、会议室状态
3. **物联网设备**: 低功耗传感器数据显示
4. **智能家居**: 温湿度显示、控制面板

### 技术优势
1. **超低功耗**: 深度睡眠模式适合电池供电
2. **无线更新**: 支持BLE和WiFi远程更新
3. **逆向兼容**: 通过逆向工程支持现有硬件
4. **双平台**: 提供ESP-IDF和Arduino两种版本

## 相关文档

### 项目文档
1. [EPD引脚逆向分析报告](docs/EPD_pin_investigation.md) - 详细的逆向工程分析
2. [README.md](README.md) - 基本项目说明
3. [工具脚本](tools/epd_pin_test.py) - EPD引脚测试工具

### 技术参考
1. [ESP-IDF文档](https://docs.espressif.com/projects/esp-idf/)
2. [ESP32-C3数据手册](https://www.espressif.com/sites/default/files/documentation/esp32-c3_datasheet_cn.pdf)
3. [SSD1677数据手册](https://www.solomon-systech.com/product/ssd1677/)

## 贡献与支持

### 开发团队
- 项目基于ESP-IDF Hello World示例
- 添加了电子纸驱动和逆向工程分析
- 集成了BLE、WiFi等无线功能

### 问题反馈
- GitHub Issues: [项目仓库](https://github.com/your-repo)
- 技术论坛: [esp32.com](https://esp32.com/)

### 许可证
基于ESP-IDF示例代码，遵循相应开源协议。

---

**文档版本**: 1.0
**最后更新**: 2025-12-29
**生成工具**: Claude Code