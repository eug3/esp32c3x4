```
局部刷新边界验证流程图
====================================

应用层 (reader_screen_simple.c)
  │
  │ display_refresh_region(x=400, y=700, w=200, h=200)
  │
  ▼
┌─────────────────────────────────────────┐
│ 验证点1: display_refresh_region        │
│ ┌───────────────────────────────────┐   │
│ │ if (x < 0) x = 0;                │   │
│ │ if (y < 0) y = 0;                │   │
│ │ if (x + width > 480)             │   │
│ │   width = 480 - x;               │   │
│ │ if (y + height > 800)            │   │
│ │   height = 800 - y;  ← 触发！    │   │
│ └───────────────────────────────────┘   │
│ 输出: x=400, y=700, w=200, h=100       │
└─────────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────────┐
│ 验证点2: expand_dirty_region            │
│ ┌───────────────────────────────────┐   │
│ │ // 负坐标处理                     │   │
│ │ if (x < 0) { width += x; x = 0; }│   │
│ │ if (y < 0) { height += y; y = 0;}│   │
│ │                                   │   │
│ │ // 尺寸验证                       │   │
│ │ if (width <= 0 || height <= 0)   │   │
│ │   return;                         │   │
│ │                                   │   │
│ │ // 范围限制                       │   │
│ │ if (x >= 480 || y >= 800)        │   │
│ │   return;                         │   │
│ │                                   │   │
│ │ if (x + width > 480)             │   │
│ │   width = 480 - x;               │   │
│ │ if (y + height > 800)            │   │
│ │   height = 800 - y;              │   │
│ │                                   │   │
│ │ // 扩展后二次验证                 │   │
│ │ if (dirty.x + dirty.width > 480) │   │
│ │   dirty.width = 480 - dirty.x;   │   │
│ └───────────────────────────────────┘   │
│ 脏区域: (400, 700, 200, 100)           │
└─────────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────────┐
│ 坐标转换: ROTATE_270                    │
│ 逻辑(480x800) → 物理(800x480)          │
│                                         │
│ (400, 700, 200, 100)                   │
│        ↓                                │
│ (700, 79, 100, 200)                    │
└─────────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────────┐
│ 验证点3: Display_Part_Stream_Impl      │
│ ┌───────────────────────────────────┐   │
│ │ // X坐标8像素对齐                 │   │
│ │ x_aligned = x - (x % 8);         │   │
│ │ x_end = x_aligned + w - 1;       │   │
│ │ if (x_end >= 800)                │   │
│ │   x_end = 799;                   │   │
│ │                                   │   │
│ │ // Y坐标验证                      │   │
│ │ y_end = y + h - 1;               │   │
│ │ if (y_end >= 480)                │   │
│ │   y_end = 479;                   │   │
│ └───────────────────────────────────┘   │
│ 物理区域: x=696, y=79, w=104, h=200    │
└─────────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────────┐
│ 验证点4: EPD_4in26_SetWindows          │
│ ┌───────────────────────────────────┐   │
│ │ if (Xstart >= 800)               │   │
│ │   Xstart = 799;                  │   │
│ │ if (Xend >= 800)                 │   │
│ │   Xend = 799;                    │   │
│ │ if (Ystart >= 480)               │   │
│ │   Ystart = 479;                  │   │
│ │ if (Yend >= 480)                 │   │
│ │   Yend = 479;                    │   │
│ │                                   │   │
│ │ // 确保起始 <= 结束               │   │
│ │ if (Xstart > Xend)               │   │
│ │   swap(Xstart, Xend);            │   │
│ │ if (Ystart > Yend)               │   │
│ │   swap(Ystart, Yend);            │   │
│ └───────────────────────────────────┘   │
│ 窗口: (696, 79) 到 (799, 278)          │
└─────────────────────────────────────────┘
  │
  ▼
┌─────────────────────────────────────────┐
│ 验证点5: SendRegion_FromFramebuffer    │
│ ┌───────────────────────────────────┐   │
│ │ // Stride验证                     │   │
│ │ if (fb_stride != 100)            │   │
│ │   return;                         │   │
│ │                                   │   │
│ │ // Y位置验证                      │   │
│ │ if (y >= 480)                    │   │
│ │   return;                         │   │
│ │                                   │   │
│ │ // 高度验证                       │   │
│ │ if (y + h > 480)                 │   │
│ │   h = 480 - y;                   │   │
│ │                                   │   │
│ │ // 宽度验证                       │   │
│ │ if (x_byte + w_byte > 100)       │   │
│ │   w_byte = 100 - x_byte;         │   │
│ └───────────────────────────────────┘   │
│ 帧缓冲访问: row[79]~[278], byte[87]~[99]│
│ 内存范围: 7900~27999 (< 48000 ✓)       │
└─────────────────────────────────────────┘
  │
  ▼
EPD硬件层
  │ SPI发送数据到墨水屏
  │ 控制器刷新指定窗口
  ▼
✓ 安全刷新完成

关键数据：
============
逻辑屏幕：480 × 800 像素
物理屏幕：800 × 480 像素
帧缓冲：48KB (800×480÷8)
每行：100字节 (800÷8)
X对齐：8像素边界

验证层次：
============
层1: 应用层输入验证
层2: 脏区域管理验证
层3: EPD驱动层参数验证
层4: 窗口坐标硬件验证
层5: 帧缓冲访问内存验证

保护机制：
============
✓ 5层独立验证
✓ 自动钳位越界值
✓ 早期错误返回
✓ 详细日志记录
✓ 零额外内存分配
```
