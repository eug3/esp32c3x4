# XTEINK X4 è‡ªå®šä¹‰åº”ç”¨éƒ¨ç½²å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. IDA åˆ†æç»“æœ
- **åˆ†ææ–‡ä»¶**: app0.bin (åŸå‚å›ºä»¶)
- **å‘ç°**: 
  - åˆ†åŒºè¡¨ä½ç½®: 0x8000
  - OTA Data ä½ç½®: 0xE000 (8KB)
  - åŸå‚æœªä½¿ç”¨ OTA æœºåˆ¶
  - æ‰¾åˆ° otadata è¯»å–å‡½æ•°: `sub_4208801E`

### 2. åˆ†åŒºè¡¨ç»“æ„
```
åç§»        ç±»å‹    å­ç±»å‹      å¤§å°        è¯´æ˜
0x009000    data    nvs         20KB        é…ç½®å­˜å‚¨
0x00E000    data    ota         8KB         OTA å¯åŠ¨é€‰æ‹©
0x010000    app     ota_0       6.4MB       åŸå‚å›ºä»¶ (app0)
0x650000    app     ota_1       6.4MB       è‡ªå®šä¹‰åº”ç”¨ (app1)
0x0C90000   data    spiffs      3.4MB       æ–‡ä»¶ç³»ç»Ÿ
0x0FF0000   data    coredump    64KB        å´©æºƒè½¬å‚¨
```

### 3. è‡ªå®šä¹‰åº”ç”¨
- **æ–‡ä»¶**: `test_app_xteink_v2.ino`
- **å¤§å°**: 273 KB (20% flash)
- **ä½ç½®**: 0x650000 (app1 åˆ†åŒº)
- **åŠŸèƒ½**:
  - æ˜¾ç¤ºç¡¬ä»¶ä¿¡æ¯ (ESP32-C3, 16MB flash, WiFi, BLE)
  - æ˜¾ç¤ºå½“å‰è¿è¡Œåˆ†åŒº
  - è‡ªåŠ¨è®¾ç½® app1 ä¸ºé»˜è®¤å¯åŠ¨
  - 2ç§’å¿ƒè·³è¾“å‡º
  - ä¸²å£æŒ‰é”®åˆ‡æ¢å› app0
  - å†…å­˜ç›‘æ§

### 4. OTA åˆ‡æ¢å·¥å…·
- **otadata_boot_app0.bin** - åˆ‡æ¢åˆ°åŸå‚å›ºä»¶
- **otadata_boot_app1.bin** - åˆ‡æ¢åˆ°è‡ªå®šä¹‰åº”ç”¨
- **CRC éªŒè¯**: å·²é€šè¿‡
- **æ ¼å¼**: ESP32 OTA Data v1

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨åˆ°è‡ªå®šä¹‰åº”ç”¨ (app1)
```powershell
# 1. çƒ§å½• OTA data
d:\esp32c3x4\esp32_env\Scripts\python.exe -m esptool -p COM5 --chip esp32c3 write_flash 0xE000 otadata_boot_app1.bin

# 2. é‡å¯è®¾å¤‡ (ç­‰å¾…ä¸²å£é‡Šæ”¾å)
d:\esp32c3x4\esp32_env\Scripts\python.exe -m esptool -p COM5 --chip esp32c3 run

# 3. æŸ¥çœ‹ä¸²å£è¾“å‡º
d:\esp32c3x4\esp32_env\Scripts\python.exe -m serial.tools.miniterm COM5 115200
```

### åˆ‡æ¢å›åŸå‚å›ºä»¶ (app0)
```powershell
# æ–¹æ³• 1: çƒ§å½• otadata
d:\esp32c3x4\esp32_env\Scripts\python.exe -m esptool -p COM5 --chip esp32c3 write_flash 0xE000 otadata_boot_app0.bin

# æ–¹æ³• 2: åœ¨è‡ªå®šä¹‰åº”ç”¨ä¸²å£ä¸­æŒ‰ä»»æ„é”®
# (è‡ªåŠ¨åˆ‡æ¢å¹¶é‡å¯)
```

### éªŒè¯å½“å‰å¯åŠ¨åˆ†åŒº
```powershell
# è¯»å– otadata
d:\esp32c3x4\esp32_env\Scripts\python.exe -m esptool -p COM5 --chip esp32c3 read_flash 0xE000 0x40 otadata_current.bin

# è§£æ
python -c "import struct; data=open('otadata_current.bin','rb').read(); print(f'ota_seq={struct.unpack(\"<I\",data[4:8])[0]} (0=app0, 1=app1)')"
```

---

## ğŸ“Š é¢„æœŸå¯åŠ¨æ—¥å¿—

### app1 (è‡ªå®šä¹‰åº”ç”¨) å¯åŠ¨è¾“å‡º
```
========================================
  XTEINK X4 è‡ªå®šä¹‰åº”ç”¨ v2
========================================

å½“å‰è¿è¡Œåˆ†åŒº: app1 (0x00650000)
æ£€æµ‹åˆ°åœ¨ app1ï¼Œè®¾ç½®ä¸ºé»˜è®¤å¯åŠ¨...
âœ“ æˆåŠŸè®¾ç½® app1 ä¸ºå¯åŠ¨åˆ†åŒº

--- ç¡¬ä»¶ä¿¡æ¯ ---
å‹å·: esp32c3
æ ¸å¿ƒæ•°: 1
Flash: 16 MB
WiFi: YES
BLE: YES

========================================
  åº”ç”¨å¯åŠ¨æˆåŠŸï¼
========================================

æç¤º: æŒ‰ä»»æ„é”®åˆ‡æ¢å›åŸå‚å›ºä»¶

[1] â¤ è¿è¡Œæ—¶é—´: 2 ç§’ | å†…å­˜: 315744 bytes
[2] â¤ è¿è¡Œæ—¶é—´: 4 ç§’ | å†…å­˜: 315744 bytes
...
```

### app0 (åŸå‚å›ºä»¶) å¯åŠ¨è¾“å‡º
(å–å†³äºåŸå‚å›ºä»¶å®ç°ï¼Œå¯èƒ½æ— ä¸²å£è¾“å‡ºæˆ–æ˜¾ç¤ºå¢¨æ°´å±ç•Œé¢)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å®‰å…¨æ€§
- âœ… **åˆ†åŒºè¡¨æœªä¿®æ”¹** - ä½¿ç”¨åŸå‚å¸ƒå±€
- âœ… **bootloader æœªä¿®æ”¹** - ä¿æŒåŸå‚
- âœ… **åŸå‚å›ºä»¶å®Œæ•´** - app0 æœªè¢«è¦†ç›–
- âœ… **å¯éšæ—¶æ¢å¤** - å¤‡ä»½å·²åˆ›å»º (app1_backup.bin)

### é™åˆ¶
- è‡ªå®šä¹‰åº”ç”¨å¤§å°å¿…é¡» â‰¤ 6.4MB
- å¢¨æ°´å±é©±åŠ¨æœªé›†æˆï¼ˆéœ€è¦é€†å‘åŸå‚é©±åŠ¨æˆ–ä½¿ç”¨é€šç”¨åº“ï¼‰
- WiFi/BLE åŠŸèƒ½éœ€è¦é¢å¤–é…ç½®
- åŸå‚åº”ç”¨å¯èƒ½éœ€è¦ç‰¹å®šçš„ NVS é…ç½®

### æ¢å¤æ–¹æ¡ˆ
```powershell
# å®Œæ•´æ¢å¤åŸå‚
d:\esp32c3x4\esp32_env\Scripts\python.exe -m esptool -p COM5 --chip esp32c3 write_flash 0x0 flash_dump.bin

# åªæ¢å¤ app1 åˆ†åŒº
d:\esp32c3x4\esp32_env\Scripts\python.exe -m esptool -p COM5 --chip esp32c3 write_flash 0x650000 app1_backup.bin
```

---

## ğŸ“ é¡¹ç›®æ–‡ä»¶æ¸…å•

### æºä»£ç 
- `test_app_xteink_v2/test_app_xteink_v2.ino` - è‡ªå®šä¹‰åº”ç”¨æºç 
- `test_app_xteink_v2/build/.../*.bin` - ç¼–è¯‘è¾“å‡º

### å·¥å…·è„šæœ¬
- `create_correct_otadata.py` - OTA data ç”Ÿæˆå·¥å…·
- `analyze_flash.py` - åˆ†åŒºè¡¨åˆ†æå·¥å…·
- `test_custom_app.ps1` - æµ‹è¯•å’Œåˆ‡æ¢è„šæœ¬
- `extract_app1.py` - app1 å¤‡ä»½æå–å·¥å…·

### äºŒè¿›åˆ¶æ–‡ä»¶
- `flash_dump.bin` - å®Œæ•´åŸå‚å›ºä»¶ (16MB)
- `app1_backup.bin` - app1 åˆ†åŒºå¤‡ä»½ (6.4MB)
- `otadata_boot_app0.bin` - å¯åŠ¨åˆ° app0
- `otadata_boot_app1.bin` - å¯åŠ¨åˆ° app1

### IDA åˆ†æ
- `app0.bin` - åŸå‚å›ºä»¶ (å¾…åˆ†æ)
- `app1.bin` - åŸå‚å›ºä»¶å¤‡ä»½
- IDA æ•°æ®åº“: app0.i64, app0.id0, app0.id1

---

## ğŸ”¬ ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

### 1. å¢¨æ°´å±é›†æˆ
- é€†å‘ app0.bin æ‰¾åˆ°å¢¨æ°´å±åˆå§‹åŒ–ä»£ç 
- æå– GPIO é…ç½®å’Œé©±åŠ¨å‡½æ•°
- é›†æˆåˆ°è‡ªå®šä¹‰åº”ç”¨

### 2. åŠŸèƒ½æ‰©å±•
- WiFi é…ç½®ç•Œé¢
- OTA è¿œç¨‹æ›´æ–°
- SPIFFS æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨
- æŒ‰é”®æ£€æµ‹å’Œäº¤äº’

### 3. æ€§èƒ½ä¼˜åŒ–
- æ·±åº¦ç¡çœ æ¨¡å¼ï¼ˆå»¶é•¿ç»­èˆªï¼‰
- å‡å°‘å¯åŠ¨æ—¶é—´
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨

### 4. è°ƒè¯•å·¥å…·
- JTAG è°ƒè¯•é…ç½®
- æ—¥å¿—ç³»ç»Ÿ
- æ€§èƒ½åˆ†æ

---

## ğŸ“ æ•…éšœæ’æŸ¥

### é—®é¢˜: è®¾å¤‡å¯åŠ¨å¾ªç¯
**åŸå› **: OTA data æŸå
**è§£å†³**:
```powershell
d:\esp32c3x4\esp32_env\Scripts\python.exe -m esptool -p COM5 --chip esp32c3 write_flash 0x0 flash_dump.bin
```

### é—®é¢˜: ä¸²å£æ— è¾“å‡º
**åŸå› **: 
1. åº”ç”¨æœªè¿è¡Œ
2. æ³¢ç‰¹ç‡ä¸åŒ¹é…
3. åŸå‚å›ºä»¶æ— ä¸²å£è¾“å‡º

**è§£å†³**: éªŒè¯ otadata è®¾ç½®ï¼Œç¡®è®¤è¿è¡Œ app1

### é—®é¢˜: åº”ç”¨è¿è¡Œä½†åŠŸèƒ½å¼‚å¸¸
**åŸå› **: NVS é…ç½®ç¼ºå¤±æˆ–é”™è¯¯
**è§£å†³**: åˆå§‹åŒ– NVS å¹¶è®¾ç½®é»˜è®¤å€¼

---

## âœ¨ æˆåŠŸæ ‡å¿—

è¿è¡Œä»¥ä¸‹å‘½ä»¤åº”è¯¥çœ‹åˆ°è‡ªå®šä¹‰åº”ç”¨è¾“å‡ºï¼š
```powershell
d:\esp32c3x4\esp32_env\Scripts\python.exe -m serial.tools.miniterm COM5 115200
```

é¢„æœŸè¾“å‡ºåŒ…å«:
- "XTEINK X4 è‡ªå®šä¹‰åº”ç”¨ v2"
- "å½“å‰è¿è¡Œåˆ†åŒº: app1"
- "åº”ç”¨å¯åŠ¨æˆåŠŸï¼"
- æŒç»­çš„å¿ƒè·³è¾“å‡º

---

**éƒ¨ç½²æ—¥æœŸ**: 2025-12-26
**ç‰ˆæœ¬**: v2.0
**çŠ¶æ€**: âœ… å°±ç»ªéƒ¨ç½²
